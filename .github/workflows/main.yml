name: 'neorv32-verilog check'

on:
  push:
  pull_request:
  schedule:
    - cron: '0 0 * * 5'
  workflow_dispatch:


jobs:

  convert:
    name: '♻️ Convert to Verilog'
    runs-on: ubuntu-latest

    steps:

    - name: '📂 Repository Checkout'
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive

    - name: '📦 Install GHDL'
      uses: ghdl/setup-ghdl@v1
      with:
        version: nightly
        backend: mcode

    - name: '⚙️ Run conversion'
      run: |
        make clean check convert

    - name: '📤 Archive generated Verilog code'
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: neorv32_verilog_wrapper
        path: src/neorv32_verilog_wrapper.v


  sim_iverilog:
    name: '🖥️ Simulation - Icarus Verilog'
    needs: convert
    runs-on: ubuntu-latest

    steps:

    - name: '📂 Repository Checkout'
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive

    - name: '📂 Checkout Conversion Artifact'
      uses: actions/download-artifact@v4
      with:
        name: neorv32_verilog_wrapper
        path: src

    - name: '📦 Install Icarus Verilog'
      run: sudo apt install iverilog

    - name: '⚙️ Run Simulation'
      run: |
        make SIMULATOR=iverilog sim | tee iverilog.log
        grep 'Simulation successful!' iverilog.log


  sim_verilator:
    name: '🖥️ Simulation - Verilator'
    needs: convert
    runs-on: ubuntu-latest

    steps:

    - name: '📂 Repository Checkout'
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive

    - name: '📂 Checkout Conversion Artifact'
      uses: actions/download-artifact@v4
      with:
        name: neorv32_verilog_wrapper
        path: src

    - name: '📦 Install Verilator'
      run: sudo apt install verilator

    - name: '⚙️ Run Simulation'
      run: |
        make SIMULATOR=verilator sim | tee verilator.log
        grep 'Simulation successful!' verilator.log
