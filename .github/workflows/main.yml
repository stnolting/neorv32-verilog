name: 'neorv32-verilog check'

on:
  push:
  pull_request:
  schedule:
    - cron: '0 0 * * 5'
  workflow_dispatch:


jobs:

  convert:
    name: 'â™»ï¸ Convert to Verilog'
    runs-on: ubuntu-latest

    steps:

    - name: 'ğŸ“‚ Repository Checkout'
      uses: actions/checkout@v6
      with:
        fetch-depth: 0
        submodules: recursive

    - name: 'ğŸ“¦ Install GHDL'
      uses: ghdl/setup-ghdl@v1
      with:
        version: nightly
        backend: mcode

    - name: 'âš™ï¸ Run conversion'
      run: |
        make clean check convert

    - name: 'ğŸ“¤ Archive generated Verilog code'
      if: always()
      uses: actions/upload-artifact@v5
      with:
        name: neorv32_verilog_wrapper
        path: src/neorv32_verilog_wrapper.v


  sim_iverilog:
    name: 'ğŸ–¥ï¸ Simulation - Icarus Verilog'
    needs: convert
    runs-on: ubuntu-latest

    steps:

    - name: 'ğŸ“‚ Repository Checkout'
      uses: actions/checkout@v6
      with:
        fetch-depth: 0
        submodules: recursive

    - name: 'ğŸ“‚ Checkout Conversion Artifact'
      uses: actions/download-artifact@v6
      with:
        name: neorv32_verilog_wrapper
        path: src

    - name: 'ğŸ“¦ Install Icarus Verilog'
      run: sudo apt install iverilog

    - name: 'âš™ï¸ Run Simulation'
      run: |
        make SIMULATOR=iverilog sim | tee iverilog.log
        grep 'Simulation successful!' iverilog.log


  sim_verilator:
    name: 'ğŸ–¥ï¸ Simulation - Verilator'
    needs: convert
    runs-on: ubuntu-latest

    steps:

    - name: 'ğŸ“‚ Repository Checkout'
      uses: actions/checkout@v6
      with:
        fetch-depth: 0
        submodules: recursive

    - name: 'ğŸ“‚ Checkout Conversion Artifact'
      uses: actions/download-artifact@v6
      with:
        name: neorv32_verilog_wrapper
        path: src

    - name: 'ğŸ“¦ Install Verilator'
      run: sudo apt install verilator

    - name: 'âš™ï¸ Run Simulation'
      run: |
        make sim SIMULATOR=verilator DUMP_WAVE=1 | tee verilator.log
        grep 'Simulation successful!' verilator.log

    - name: 'ğŸ“¤ Archive generated waveform'
      uses: actions/upload-artifact@v5
      with:
        name: wave.fst
        path: wave.fst
